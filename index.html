<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Text → CSV Voter Converter</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--accent:#2563eb}
    body{font-family:Inter, system-ui, -apple-system, Noto Sans, Arial; background:var(--bg); margin:0; padding:20px}
    .wrap{max-width:1100px;margin:18px auto;background:var(--card);border-radius:10px;padding:18px;box-shadow:0 8px 30px rgba(10,20,40,0.06)}
    h1{font-size:20px;margin:0 0 8px}
    p.lead{margin:0 0 18px;color:#374151}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{display:block;font-weight:600;margin-bottom:6px}
    textarea{width:100%;min-height:260px;padding:12px;border-radius:8px;border:1px solid #e5e7eb;font-family:monospace;white-space:pre-wrap}
    .controls{display:flex;gap:10px;align-items:center;margin-top:12px}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    button.secondary{background:#6b7280}
    .small{padding:6px 10px;font-size:13px}
    .output{margin-top:14px;background:#0b1220;color:#fff;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:320px;overflow:auto}
    .row{display:flex;gap:10px;align-items:center}
    input,select{padding:8px;border-radius:8px;border:1px solid #ddd}
    .note{font-size:13px;color:#6b7280;margin-top:8px}
    footer{margin-top:14px;text-align:right;color:#6b7280}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Text → CSV Voter Converter (Sample-based)</h1>
    <p class="lead">ऊपर sample CSV header डालें (जिस format में CSV चाहिए) और नीचे raw text paste करें। फिर Convert दबाएँ — CSV डाउनलोड हो जाएगा।</p>

    <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
      <div class="row">
        <label style="margin-right:8px">Start Serial No</label>
        <input id="startSerial" type="number" value="571" style="width:120px" />
      </div>
      <div class="row">
        <label style="margin-right:8px">Delimiter</label>
        <input id="delimiter" value="," style="width:80px" />
      </div>
      <div class="row">
        <label style="margin-right:8px">Detect Language</label>
        <select id="lang">
          <option value="auto">Auto (मराठी/हिंदी/English)</option>
        </select>
      </div>
    </div>

    <div class="grid">
      <div>
        <label>1) Sample CSV Header (one line)</label>
        <textarea id="sample" placeholder="SerialNo,EPIC_NO,PartNo,VoterName,RelationName,RelationType,HouseNo,Age,Gender">SerialNo,EPIC_NO,PartNo,VoterName,RelationName,RelationType,HouseNo,Age,Gender</textarea>
        <div class="note">उदाहरण: SerialNo,EPIC_NO,PartNo,VoterName,RelationName,RelationType,HouseNo,Age,Gender</div>
      </div>

      <div>
        <label>2) Raw Text (PDF → Text से जो मिला)</label>
        <textarea id="raw" placeholder="यहाँ raw text पेस्ट करें..."> </textarea>
        <div class="controls">
          <button id="convert">Convert → CSV</button>
          <button id="previewBtn" class="secondary small">Preview Rows</button>
          <button id="clear" class="secondary small">Clear</button>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1">
        <label>CSV Output (preview)</label>
        <div id="out" class="output">Converted CSV will appear here...</div>
      </div>

      <div style="width:260px">
        <label>Actions</label>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="download" class="small">Download CSV</button>
          <button id="copy" class="small secondary">Copy to Clipboard</button>
          <button id="showLog" class="small secondary">Show Parse Log</button>
        </div>
        <div class="note">Parsing uses heuristics: EPIC (RBG...), PartNo (x/x/x), names via "मतदाराचे पूर्ण" / "नांव" / "पतीचे नाव" / "वडिलांचे नाव", age via "वय" and gender via "लिंग".</div>
      </div>
    </div>

    <div id="log" style="margin-top:12px;display:none;background:#fff8; padding:10px;border-radius:8px;white-space:pre-wrap;max-height:240px;overflow:auto"></div>

    <footer>Tool made for voter-list cleanup • If some rows are wrong, tweak raw text or paste more context above each entry.</footer>
  </div>

<script>
(function(){
  const sampleEl = document.getElementById('sample');
  const rawEl = document.getElementById('raw');
  const outEl = document.getElementById('out');
  const convertBtn = document.getElementById('convert');
  const previewBtn = document.getElementById('previewBtn');
  const downloadBtn = document.getElementById('download');
  const copyBtn = document.getElementById('copy');
  const clearBtn = document.getElementById('clear');
  const logEl = document.getElementById('log');
  const showLogBtn = document.getElementById('showLog');
  const startSerialEl = document.getElementById('startSerial');
  const delimEl = document.getElementById('delimiter');

  function normalize(text){
    // remove BOM and normalize spaces and weird punctuation
    return text.replace(/\uFEFF/g,'').replace(/\r/g,'').replace(/\t/g,' ').replace(/\u00A0/g,' ').replace(/ +/g,' ').trim();
  }

  function splitBlocksByEpic(raw){
    // Find all positions of EPIC markers like RBG12345 or patterns like RBG5764923 131/272/595
    const idxs = [];
    const re = /RBG\d{4,}/gi;
    let m;
    while((m = re.exec(raw)) !== null){ idxs.push(m.index); }
    if(idxs.length === 0){
      // fallback: split by lines that look like a serial number (3-digit) followed by RBG etc.
      return raw.split(/\n\s*\d{1,4}\s*\n/).map(s=>s.trim()).filter(Boolean);
    }
    const blocks = [];
    for(let i=0;i<idxs.length;i++){
      const start = idxs[i];
      const end = (i+1<idxs.length)? idxs[i+1] : raw.length;
      blocks.push(raw.slice(start,end).trim());
    }
    return blocks;
  }

  function extractField(block){
    const res = {
      EPIC:'', PartNo:'', Serial:'', VoterName:'', RelationName:'', RelationType:'', HouseNo:'', Age:'', Gender:''
    };
    // EPIC
    const epicMatch = block.match(/(RBG\d{4,})/i);
    if(epicMatch) res.EPIC = epicMatch[1].toUpperCase();
    // PartNo: find pattern like 131/272/587 or 131/272/595 etc
    const partMatch = block.match(/(\d{1,3}\/\d{1,3}\/\d{1,4})/);
    if(partMatch) res.PartNo = partMatch[1];

    // Serial: often appears as a number before EPIC in original file; try to find leading 1-3 digit number in block start
    const serialMatch = block.match(/^(\d{1,4})\b/);
    if(serialMatch) res.Serial = serialMatch[1];

    // VoterName: look for "मतदाराचे पूर्ण" or "मतदाराचे पूर्ण:" or "मतदाराचे पूर्ण" then name tokens
    let nameMatch = block.match(/मतदाराचे\s*पूर्ण[:\s]*([^\n|\|,]+)/i);
    if(!nameMatch) nameMatch = block.match(/मतदाराचे\s*पूर्ण[:\s]*([\w\u0900-\u097F\s.'-]+)/i);
    if(nameMatch){ res.VoterName = nameMatch[1].trim().replace(/\s+/g,' '); }
    // fallback: look for line starting with name tokens after EPIC
    if(!res.VoterName){
      // find lines and pick first line with two or three Devanagari words (a crude name heuristic)
      const lines = block.split('\n').map(l=>l.trim()).filter(Boolean);
      for(const ln of lines){
        // if line contains words and not keywords
        if(/[\u0900-\u097F]/.test(ln) && !/(RBG|मतदार|वडिल|पती|नांव|वय|लिंग|Photo|Available)/i.test(ln)){
          const words = ln.split(/\s+/);
          if(words.length>=2 && words.length<=4){ res.VoterName = ln.replace(/\|/g,' ').trim(); break; }
        }
      }
    }

    // Relation names: look for husband/father/mother keywords
    const husbandMatch = block.match(/पतीचे\s*नाव[:\s]*([\u0900-\u097F\w\s.'-]+)/i);
    const fatherMatch = block.match(/वडिलांचे\s*नाव[:\s]*([\u0900-\u097F\w\s.'-]+)/i);
    const motherMatch = block.match(/आईचे\s*नाव[:\s]*([\u0900-\u097F\w\s.'-]+)/i);
    if(husbandMatch){ res.RelationName = husbandMatch[1].trim(); res.RelationType = 'Husband'; }
    else if(fatherMatch){ res.RelationName = fatherMatch[1].trim(); res.RelationType = 'Father'; }
    else if(motherMatch){ res.RelationName = motherMatch[1].trim(); res.RelationType = 'Mother'; }
    else {
      // sometimes father's name appears as "नांव ..." pattern after name
      const alt = block.match(/नांव[:\s]*([\u0900-\u097F\w\s.'-]+)/i);
      if(alt){ res.RelationName = alt[1].trim(); }
    }

    // Age
    const ageMatch = block.match(/वय\s*[:\s]*([0-9]{1,2})/);
    if(ageMatch) res.Age = ageMatch[1];
    // Gender
    const genderMatch = block.match(/लिंग\s*[:\s]*(पु|पुरुष|स्त्री|महिला|Male|Female)/i);
    if(genderMatch){
      const g = genderMatch[1];
      if(/स्त्री|महिला|female/i.test(g)) res.Gender = 'Female';
      else res.Gender = 'Male';
    }

    // HouseNo: look for "घर क्रमांक" or CHAWL/Niwas/Bungalow/COMPOUND/GALA
    const houseMatch = block.match(/घर\s*क्रमांक\s*[:\s]*([^\n,|]+)/i);
    if(houseMatch) res.HouseNo = houseMatch[1].trim();
    else {
      const house2 = block.match(/([\w\s,\-]*?(?:CHAWL|chawl|Niwas|Bungalow|Compound|GALA|Gala|MS CHAWL|M\.S chawl|M S chawl)[\w\s,\-]*)/i);
      if(house2) res.HouseNo = house2[0].trim();
    }

    // trim quotes and pipes
    for(const k of Object.keys(res)) if(typeof res[k]==='string') res[k]=res[k].replace(/\|/g,'').replace(/\s+/g,' ').trim();
    return res;
  }

  function buildCSV(rows, header, delim){
    const esc = s => {
      if(s==null) s='';
      s = String(s);
      if(s.indexOf('"')!==-1) s = s.replace(/"/g,'""');
      if(s.indexOf(delim)!==-1 || s.indexOf('\n')!==-1 || s.indexOf('"')!==-1) return '"'+s+'"';
      return s;
    }
    const lines = [header.split(',').map(h=>h.trim()).join(delim)];
    for(const r of rows){
      const vals = header.split(',').map(col=>{
        const key = col.trim();
        // mapping from header names to row object
        switch(key){
          case 'SerialNo': return esc(r.Serial || '');
          case 'EPIC_NO': return esc(r.EPIC || '');
          case 'PartNo': return esc(r.PartNo || '');
          case 'VoterName': return esc(r.VoterName || '');
          case 'RelationName': return esc(r.RelationName || '');
          case 'RelationType': return esc(r.RelationType || '');
          case 'HouseNo': return esc(r.HouseNo || '');
          case 'Age': return esc(r.Age || '');
          case 'Gender': return esc(r.Gender || '');
          default: return esc(r[key]||'');
        }
      });
      lines.push(vals.join(delim));
    }
    return lines.join('\r\n');
  }

  function parseAll(raw){
    raw = normalize(raw);
    // Ensure newlines where pipes appear
    raw = raw.replace(/\|/g,'\n');
    // Also put newline before common markers to help block splitting
    raw = raw.replace(/(RBG\d{4,})/gi,'\n$1');
    // collapse multiple newlines
    raw = raw.replace(/\n{2,}/g,'\n');

    const blocks = splitBlocksByEpic(raw);
    const rows = [];
    const log = [];
    for(let i=0;i<blocks.length;i++){
      const b = blocks[i];
      const parsed = extractField(b);
      log.push({index:i,parsed,rawSnippet:b.slice(0,200)});
      rows.push(parsed);
    }
    return {rows,log};
  }

  convertBtn.addEventListener('click', ()=>{
    const sample = sampleEl.value.trim();
    const raw = rawEl.value.trim();
    const startSerial = parseInt(startSerialEl.value) || 1;
    const delim = delimEl.value || ',';
    if(!sample){ alert('Please enter sample header'); return; }
    if(!raw){ alert('Please paste raw text'); return; }

    const {rows,log} = parseAll(raw);
    // assign serials and improve names: if relation type empty but relationName present, set type via keyword
    const outRows = rows.map((r, idx) => {
      const obj = Object.assign({}, r);
      if(!obj.Serial) obj.Serial = (startSerial + idx).toString();
      // If VoterName empty, try to pull first two words from block raw (already attempted)
      // Clean Devanagari spacing
      if(obj.VoterName){ obj.VoterName = obj.VoterName.replace(/\s{2,}/g,' ').trim(); }
      if(obj.RelationType==='' && obj.RelationName){
        // detect husband or father from name context (not reliable) - leave blank
      }
      return obj;
    });

    const csv = buildCSV(outRows, sample, delim);
    outEl.textContent = csv;
    logEl.textContent = JSON.stringify(log, null, 2);
    logEl.style.display = 'none';
    // prepare download
    downloadBtn.dataset.csv = csv;
  });

  previewBtn.addEventListener('click', ()=>{
    const raw = rawEl.value.trim();
    if(!raw){ alert('Paste raw text first'); return; }
    const {rows,log} = parseAll(raw);
    // show first 8 parsed
    const preview = rows.slice(0,12).map((r,i)=> `${i+1}. ${r.EPIC||''} | ${r.PartNo||''} | ${r.VoterName||''} | ${r.RelationName||''} | ${r.HouseNo||''} | ${r.Age||''} | ${r.Gender||''}`).join('\n');
    outEl.textContent = preview || '(no rows parsed)';
    logEl.textContent = JSON.stringify(log, null, 2);
    logEl.style.display = 'block';
  });

  clearBtn.addEventListener('click', ()=>{ rawEl.value=''; outEl.textContent='Converted CSV will appear here...'; logEl.style.display='none'; });

  downloadBtn.addEventListener('click', ()=>{
    const csv = downloadBtn.dataset.csv;
    if(!csv){ alert('No CSV yet — click Convert first'); return; }
    const bom = '\uFEFF';
    const blob = new Blob([bom + csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'voters_converted.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  copyBtn.addEventListener('click', async ()=>{
    const text = outEl.textContent;
    if(!text){ alert('Nothing to copy'); return; }
    try{ await navigator.clipboard.writeText(text); alert('Copied to clipboard'); }catch(e){ alert('Copy failed: '+e.message); }
  });

  showLogBtn.addEventListener('click', ()=>{ logEl.style.display = (logEl.style.display==='none')? 'block':'none'; });

})();
</script>
</body>
</html>
