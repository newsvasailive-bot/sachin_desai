<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter List CSV Fixer - Fixed Header</title>
<style>
body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 20px; }
h2 { text-align: center; color: #333; }
p { text-align: center; }
textarea { width: 100%; height: 350px; margin-bottom: 15px; padding: 15px; font-size: 14px;
    border: 2px solid #ccc; box-sizing: border-box; resize: vertical; }
.button-container { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
.button-container button {
    padding: 12px 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px;
    transition: background-color 0.3s; width: 100%;
}
#generateButton { background-color: #007bff; color: white; }
#generateButton:hover { background-color: #0056b3; }
#copyButton { background-color: #28a745; color: white; }
#copyButton:hover { background-color: #218838; }
#outputCSV { width: 100%; height: 300px; padding: 10px;
    font-family: Consolas, monospace; font-size: 13px; border: 1px solid #ddd;
    box-sizing: border-box; white-space: pre-wrap;
}
</style>
</head>
<body>

<h2>Voter List CSV Fixer üöÄ (Final Solution)</h2>
<p>Raw voter text ‡§Ø‡§π‡§æ‡§Å paste ‡§ï‡§∞‡•á‡§Ç:</p>
<textarea id="inputText" placeholder="‡§ï‡§ö‡•ç‡§ö‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§Ø‡§π‡§æ‡§Å ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç"></textarea>

<div class="button-container">
    <button id="generateButton" onclick="generateCSV()">CSV Generate ‡§ï‡§∞‡•á‡§Ç</button>
    <button id="copyButton" onclick="copyCSV()" disabled>üìã CSV ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç</button>
</div>

<h3>Output CSV:</h3>
<textarea id="outputCSV" readonly placeholder="‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ CSV ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§ó‡§æ‡•§"></textarea>

<script>
// ===================== FIXED HEADER =====================
const FIXED_HEADER =
"SerialNo,EPIC_NO,PartNo,VoterName,RelationName,RelationType,HouseNo,Age,Gender";

// ===================== MAIN FUNCTION =====================
function generateCSV() {
    const raw = document.getElementById("inputText").value.trim();
    const out = document.getElementById("outputCSV");
    const copyBtn = document.getElementById("copyButton");

    if (!raw) {
        out.value = FIXED_HEADER + "\n‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§á‡§®‡§™‡•Å‡§ü ‡§°‡§æ‡§≤‡•á‡§Ç!";
        return;
    }

    // Clean text
    let text = raw
        .replace(/\|/g, " ")
        .replace(/\n/g, " ")
        .replace(/\s+/g, " ")
        .trim();

    // Detect EPIC + PART
    const epicRegex = /(RBG\w+)\s+(\d{1,3}\/\d{1,3}\/\d+)/gi;
    const matches = [...text.matchAll(epicRegex)];

    if (matches.length === 0) {
        out.value = "‚ùå EPIC ‡§®‡§Ç‡§¨‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!";
        return;
    }

    let csv = FIXED_HEADER + "\n";
    let serial = 1;

    for (let i = 0; i < matches.length; i++) {
        const start = matches[i].index;
        const end = (i + 1 < matches.length) ? matches[i + 1].index : text.length;
        const block = text.substring(start, end).trim();

        let epic = matches[i][1];
        let part = matches[i][2];

        // --- Extract Voter Name ---
        let voterName = "NA";
        let nm = block.match(/‡§®‡§æ‡§Ç‡§µ\s*([^:]+?)\s*(‡§™‡§§‡•Ä‡§ö‡•á|‡§µ‡§°‡§ø‡§≤‡§æ‡§Ç‡§ö‡•á|‡§Ü‡§à‡§ö‡•á|‡§ò‡§∞ ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï|Photo)/);
        if (nm) voterName = nm[1].trim();

        // --- Extract Relation ---
        let relationName = "NA", relationType = "NA";

        if (block.includes("‡§™‡§§‡•Ä‡§ö‡•á ‡§®‡§æ‡§µ")) {
            relationType = "Husband";
            relationName = (block.match(/‡§™‡§§‡•Ä‡§ö‡•á ‡§®‡§æ‡§µ\s*[:]\s*([^:]+?)\s*(‡§ò‡§∞|‡§µ‡§Ø|‡§≤‡§ø‡§Ç‡§ó|$)/) || ["","NA"])[1].trim();
        }
        else if (block.includes("‡§µ‡§°‡§ø‡§≤‡§æ‡§Ç‡§ö‡•á ‡§®‡§æ‡§µ")) {
            relationType = "Father";
            relationName = (block.match(/‡§µ‡§°‡§ø‡§≤‡§æ‡§Ç‡§ö‡•á ‡§®‡§æ‡§µ\s*[:]\s*([^:]+?)\s*(‡§ò‡§∞|‡§µ‡§Ø|‡§≤‡§ø‡§Ç‡§ó|$)/) || ["","NA"])[1].trim();
        }
        else if (block.includes("‡§Ü‡§à‡§ö‡•á ‡§®‡§æ‡§µ")) {
            relationType = "Mother";
            relationName = (block.match(/‡§Ü‡§à‡§ö‡•á ‡§®‡§æ‡§µ\s*[:]\s*([^:]+?)\s*(‡§ò‡§∞|‡§µ‡§Ø|‡§≤‡§ø‡§Ç‡§ó|$)/) || ["","NA"])[1].trim();
        }

        // --- Extract House No ---
        let house = "NA";
        let hs = block.match(/‡§ò‡§∞ ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï\s*[:]\s*([^:]+?)\s*(‡§µ‡§Ø|‡§≤‡§ø‡§Ç‡§ó|$)/);
        if (hs) house = hs[1].trim();

        // --- Extract Age ---
        let age = "NA";
        let ag = block.match(/‡§µ‡§Ø\s*[:]\s*(\d+)/);
        if (ag) age = ag[1];

        // --- Extract Gender ---
        let gender = "NA";
        if (/‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä/.test(block)) gender = "Female";
        else if (/‡§™‡•Å/.test(block)) gender = "Male";

        // ----- Build CSV Row -----
        let row = [
            serial++,
            epic,
            part,
            `"${voterName}"`,
            `"${relationName}"`,
            relationType,
            house,
            age,
            gender
        ].join(",");

        csv += row + "\n";
    }

    out.value = csv;
    copyBtn.disabled = false;
}

// ===================== COPY FUNCTION =====================
function copyCSV() {
    const out = document.getElementById("outputCSV");
    out.select();
    document.execCommand("copy");

    let btn = document.getElementById("copyButton");
    btn.textContent = "‚úî ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ!";
    setTimeout(() => btn.textContent = "üìã CSV ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç", 1500);
}
</script>

</body>
</html>
