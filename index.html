<script>
function extract() {
    let text = document.getElementById("input").value;
    let lines = text.split("\n").map(l => l.trim()).filter(l => l);
    let tbody = document.querySelector("#output tbody");
    tbody.innerHTML = "";

    let voter = {};
    let results = [];

    function pushVoter() {
        if (voter.SerialNo && voter.EPIC_NO && voter.VoterName) {
            voter.RelationType = voter.RelationType || "NA";
            voter.RelationName = voter.RelationName || "NA";
            voter.HouseNo = voter.HouseNo || "NA";
            voter.Age = voter.Age || "NA";
            voter.Gender = voter.Gender || "NA";
            voter.PartNo = voter.PartNo || "NA";

            results.push({ ...voter });
        }
        voter = {};
    }

    lines.forEach(line => {
        if (/^\d{1,4}$/.test(line)) {
            pushVoter();
            voter.SerialNo = line;
            return;
        }

        if (/^[A-Z]{3}\d{7,}/.test(line)) {
            let match = line.match(/^([A-Z]{3}\d{7,})(.*)?/);
            voter.EPIC_NO = match[1];

            let part = line.match(/\d+\/\d+\/\d+/);
            if (part) voter.PartNo = part[0];

            return;
        }

        if (line.includes("मतदाराचे पूर्ण") || line.includes("नांव")) {
            let n = line.split(":").pop().trim();
            voter.VoterName = n || "NA";
            return;
        }

        if (line.includes("पतीचे नाव")) {
            voter.RelationType = "Husband";
            voter.RelationName = line.split(":").pop().trim();
            return;
        }

        if (line.includes("वडिलांचे नाव")) {
            voter.RelationType = "Father";
            voter.RelationName = line.split(":").pop().trim();
            return;
        }

        if (line.includes("घर क्रमांक")) {
            voter.HouseNo = line.split(":").pop().trim() || "NA";
            return;
        }

        if (line.includes("वय")) {
            voter.Age = line.split(":").pop().trim();
            return;
        }

        if (line.includes("लिंग")) {
            if (line.includes("स्त्री") || line.includes("Female")) voter.Gender = "Female";
            else voter.Gender = "Male";

            pushVoter();
        }
    });

    results.forEach(r => {
        tbody.innerHTML += `
        <tr>
            <td>${r.SerialNo}</td>
            <td>${r.EPIC_NO}</td>
            <td>${r.PartNo}</td>
            <td>${r.VoterName}</td>
            <td>${r.RelationName}</td>
            <td>${r.RelationType}</td>
            <td>${r.HouseNo}</td>
            <td>${r.Age}</td>
            <td>${r.Gender}</td>
        </tr>`;
    });

    window.extracted = results;
}

function downloadCSV() {
    if (!window.extracted) return alert("Extract pehle karein!");

    let csv = "SerialNo,EPIC_NO,PartNo,VoterName,RelationName,RelationType,HouseNo,Age,Gender\n";
    window.extracted.forEach(r => {
        csv += `${r.SerialNo},${r.EPIC_NO},${r.PartNo},"${r.VoterName}","${r.RelationName}","${r.RelationType}","${r.HouseNo}","${r.Age}","${r.Gender}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");

    a.href = url;
    a.download = "voter_list.csv";
    a.click();
}
</script>
