<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter List Parser & Downloader (Offline)</title>

<style>
/* Styling for better appearance */
body { font-family: Arial, sans-serif; padding:20px; background:#f9f9f9; }
textarea { width:100%; height:200px; margin-bottom:10px; border: 1px solid #ccc; padding: 10px; box-sizing: border-box; resize: vertical; }
button { padding:10px 20px; margin:5px 5px 5px 0; cursor:pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; transition: background-color 0.3s; }
button:hover { background-color: #0056b3; }
pre { background:#eee; padding:10px; overflow-x:auto; white-space: pre-wrap; border: 1px solid #ddd; border-radius: 4px; }
h2, h3 { color: #333; }
</style>
</head>
<body>

<h2>ЁЯЧ│я╕П рд╡реЛрдЯрд░ рд▓рд┐рд╕реНрдЯ рдкрд╛рд░реНрд╕рд░ рдФрд░ рдбрд╛рдЙрдирд▓реЛрдбрд░ (рдСрдлрд▓рд╛рдЗрди)</h2>

<p>рдХрдЪреНрдЪрд╛ (Raw) рд╡реЛрдЯрд░ рд▓рд┐рд╕реНрдЯ рдЯреЗрдХреНрд╕реНрдЯ рдпрд╣рд╛рдБ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ:</p>
<textarea id="voterText" placeholder="рдХреГрдкрдпрд╛ рдЕрдкрдирд╛ рдЕрд╡реНрдпрд╡рд╕реНрдерд┐рдд рдЯреЗрдХреНрд╕реНрдЯ рдпрд╣рд╛рдБ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ..."></textarea>
<br>

<button onclick="parseVoters()">1. Parse to CSV & JSON</button>
<button onclick="downloadCSV()">2. Download CSV</button>
<button onclick="downloadJSON()">3. Download JSON</button>

<h3>CSV Output:</h3>
<pre id="csvOutput">CSV рдбреЗрдЯрд╛ рдпрд╣рд╛рдБ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛...</pre>

<h3>JSON Output:</h3>
<pre id="jsonOutput">JSON рдбреЗрдЯрд╛ рдпрд╣рд╛рдБ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛...</pre>

<script>
let voters = []; 

/**
 * рдкрд╛рда рд╕реЗ рдЕрдирд╛рд╡рд╢реНрдпрдХ рд╢рдмреНрдж рдФрд░ рдлреЙрд░реНрдореЗрдЯрд┐рдВрдЧ рд╣рдЯрд╛рддрд╛ рд╣реИред
 */
function cleanText(str) {
    if(!str) return '';
    // рд╕рднреА рдЕрдирд╛рд╡рд╢реНрдпрдХ рд▓реЗрдмрд▓ (рдЬреИрд╕реЗ рдирд╛рдВрд╡, Photo, etc.) рдФрд░ рдЕрдВрдХ (рдирд┐рдпрдорд┐рдд рдФрд░ рд╣рд┐рдВрджреА рджреЛрдиреЛрдВ) рд╣рдЯрд╛рдПрдБ
    return str.replace(/(рдирд╛рдВрд╡|Available|Photo|рдорддрджрд╛рд░рд╛рдЪреЗ|рдЙрдкрд▓рдмреНрдз|рдкреВрд░реНрдг|рдкрддреАрдЪреЗ|рд╡рдбрд┐рд▓рд╛рдВрдЪреЗ|рдЖрдИрдЪреЗ|рдирд╛рд╡|:|рдЗрддрд░)\s*|\d+|[реж-реп]+/gi, '')
              .replace(/\|\s*/g, '')
              .replace(/\r?\n/g, ' ')
              .trim()
              .replace(/^\s*:\s*/, ''); 
}

/**
 * рдХрдЪреНрдЪреЗ рдкрд╛рда рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рддрд╛ рд╣реИ рдФрд░ CSV/JSON рдореЗрдВ рдЖрдЙрдЯрдкреБрдЯ рдХрд░рддрд╛ рд╣реИред
 */
function parseVoters() {
    const text = document.getElementById('voterText').value;
    if (!text.trim()) {
        alert("рдХреГрдкрдпрд╛ рдХрдЪреНрдЪрд╛ рд╡реЛрдЯрд░ рд▓рд┐рд╕реНрдЯ рдЯреЗрдХреНрд╕реНрдЯ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВред");
        return;
    }
    
    voters = [];
    let serial = 1;

    // 1. рдЯреЗрдХреНрд╕реНрдЯ рдХреЛ рддреИрдпрд╛рд░ рдХрд░реЗрдВ: рд╕рднреА рд▓рд╛рдЗрди рдмреНрд░реЗрдХреНрд╕ рдХреЛ рд╕реНрдкреЗрд╕ рд╕реЗ рдмрджрд▓реЗрдВ, рдкрд╛рдЗрдк рдФрд░ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реНрдкреЗрд╕ рд╣рдЯрд╛рдПрдБред
    const fullText = text.replace(/\r?\n/g, ' ').replace(/\|\s*/g, ' ').replace(/\s+/g, ' ');

    // 2. ЁЯОп EPIC рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдкреВрд░реЗ рдбреЗрдЯрд╛ рдХреЛ рд╡рд┐рднрд╛рдЬрд┐рдд рдХрд░реЗрдВред (RBG1234567 рдпрд╛ MRL...)
    // EPIC рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд░рддрд╛ рд╣реИ (рдпрд╣ рд╕рдмрд╕реЗ рдордЬрд╝рдмреВрдд рд╡рд┐рднрд╛рдЬрди рдмрд┐рдВрджреБ рд╣реИ)
    const epicBlocks = fullText.split(/([A-Z]{2,}\d{6,}[A-Z]{0,})/);

    // 3. рдкрд╣рд▓реЗ рдЦрд╛рд▓реА рдмреНрд▓реЙрдХ рдХреЛ рд╣рдЯрд╛ рджреЗрдВ (рдпрджрд┐ рдореМрдЬреВрдж рд╣реЛ)
    if (epicBlocks[0] && epicBlocks[0].trim() === '') {
        epicBlocks.shift();
    }
    
    // 4. рд╣рд░ рджреЛ рдЖрдЗрдЯрдо (EPIC рдФрд░ рдЙрд╕рдХреЗ рдмрд╛рдж рдХрд╛ рдбреЗрдЯрд╛ рдмреНрд▓реЙрдХ) рдХреЛ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░реЗрдВ
    for (let i = 0; i < epicBlocks.length; i += 2) {
        // EPIC рдФрд░ рдЙрд╕рдХреЗ рдмрд╛рдж рдХрд╛ рдбреЗрдЯрд╛ рдПрдХ рд╕рд╛рде рдЬреЛрдбрд╝рдХрд░ рдкреВрд░рд╛ рд░рд┐рдХреЙрд░реНрдб рдмреНрд▓реЙрдХ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ
        const epicNo = epicBlocks[i].trim();
        const dataAfterEpic = epicBlocks[i+1] ? epicBlocks[i+1].trim() : '';
        const block = epicNo + " " + dataAfterEpic;
        
        if (!block.trim()) continue; 

        // EPIC рдФрд░ PartNo рдХреЛ рдмреНрд▓реЙрдХ рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗ рдПрдХреНрд╕рдЯреНрд░реЗрдХреНрдЯ рдХрд░реЗрдВ
        // PartNo (рдЬреИрд╕реЗ 131/272/587) EPIC рдХреЗ рдареАрдХ рдмрд╛рдж, рднрд▓реЗ рд╣реА рдмреАрдЪ рдореЗрдВ рд╕реНрдкреЗрд╕ рд╣реЛред
        const epicMatch = block.match(/([A-Z]{2,}\d{6,}[A-Z]{0,})\s*([\d\/]+)/);
        
        // рдпрджрд┐ EPIC рдФрд░ PartNo рджреЛрдиреЛрдВ рдирд╣реАрдВ рдорд┐рд▓реЗ, рддреЛ рд░рд┐рдХреЙрд░реНрдб рдЫреЛрдбрд╝ рджреЗрдВ
        if (!epicMatch || !epicMatch[1]) continue; 

        let currentVoterData = {
            SerialNo: serial++,
            EPIC_NO: epicMatch[1],
            PartNo: epicMatch[2] || 'N/A',
            VoterName: '',
            RelationName: '',
            RelationType: '',
            HouseNo: '',
            Age: '',
            Gender: ''
        };
        
        // --- рдбреЗрдЯрд╛рдмреНрд▓реЙрдХ рд╕реЗ рдЕрдиреНрдп рдлрд╝реАрд▓реНрдбреНрд╕ рдПрдХреНрд╕рдЯреНрд░реЗрдХреНрд╢рди (BLOCK рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ) ---
        
        // VoterName:
        const nameMatch = block.match(/(?:рдорддрджрд╛рд░рд╛рдЪреЗ рдкреВрд░реНрдг|Voter's Full)\s*[:|]?\s*(.+?)(?:рдирд╛рд╡|рдирд╛рдВрд╡|\||$)/i);
        if (nameMatch && nameMatch[1]) {
            currentVoterData.VoterName = cleanText(nameMatch[1].trim());
        }

        // Relation:
        const relationMatch = block.match(/(рдкрддреАрдЪреЗ|рд╡рдбрд┐рд▓рд╛рдВрдЪреЗ|рдЖрдИрдЪреЗ|рдЗрддрд░)\s*рдирд╛рд╡\s*:\s*(.+?)(?:рдШрд░ рдХреНрд░рдорд╛рдВрдХ|\s*Photo|$)/i);
        if (relationMatch && relationMatch[2]) {
            currentVoterData.RelationName = cleanText(relationMatch[2].trim());
            if (relationMatch[1].includes('рдкрддреА')) currentVoterData.RelationType = 'Husband';
            else if (relationMatch[1].includes('рд╡рдбрд┐')) currentVoterData.RelationType = 'Father';
            else if (relationMatch[1].includes('рдЖрдИ')) currentVoterData.RelationType = 'Mother';
            else currentVoterData.RelationType = 'Other';
        }
        
        // Age:
        const ageMatch = block.match(/рд╡рдп\s*:\s*(\d+|[реж-реп]+)/);
        if(ageMatch) {
            // рд╣рд┐рдВрджреА рдЕрдВрдХреЛрдВ рдХреЛ рд╣рдЯрд╛рдиреЗ рдХрд╛ рдХрд╛рдо cleanText рдореЗрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрд╣рд╛рдВ рд╕рд┐рд░реНрдлрд╝ рдкрд╛рд░реНрд╕ рдХрд░реЗрдВ
            currentVoterData.Age = ageMatch[1]; 
        }

        // Gender:
        const genderMatch = block.match(/рд▓рд┐рдВрдЧ\s*:\s*(рдкреБ|рд╕реНрддреНрд░реА|Male|Female)/i);
        if(genderMatch) {
            const g = genderMatch[1].trim();
            if(g.startsWith('рдкреБ') || g.startsWith('Ma')) currentVoterData.Gender = 'Male';
            else if(g.startsWith('рд╕реНрддреНрд░реА') || g.startsWith('Fe')) currentVoterData.Gender = 'Female';
        }

        // HouseNo: 
        const houseMatch = block.match(/рдШрд░ рдХреНрд░рдорд╛рдВрдХ\s*:\s*(.+?)(?:рд╡рдп|рд▓рд┐рдВрдЧ|$)/i);
        if (houseMatch && houseMatch[1]) {
            currentVoterData.HouseNo = cleanText(houseMatch[1].trim());
        }

        currentVoterData.VoterName = cleanText(currentVoterData.VoterName);
        
        voters.push(currentVoterData);
    }
    
    // ===== Output Generation (CSV & JSON) =====
    const escapeCSV = str => `"${String(str || '').replace(/"/g,'""').replace(/\n/g,' ').replace(/\r/g,' ')}"`;
    const csvHeader = 'SerialNo,EPIC_NO,PartNo,VoterName,RelationName,RelationType,HouseNo,Age,Gender';
    const csvRows = voters.map(v => [
        v.SerialNo, v.EPIC_NO, v.PartNo, 
        escapeCSV(v.VoterName), escapeCSV(v.RelationName), v.RelationType, 
        escapeCSV(v.HouseNo), v.Age, v.Gender
    ].join(','));
    document.getElementById('csvOutput').textContent = [csvHeader, ...csvRows].join('\n');
    document.getElementById('jsonOutput').textContent = JSON.stringify(voters, null, 2);
    
    if (voters.length > 0) {
        alert(`${voters.length} рдорддрджрд╛рддрд╛ рд░рд┐рдХреЙрд░реНрдб рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкрд╛рд░реНрд╕ рдХрд┐рдП рдЧрдПред рдЕрдм рдЖрдк рдбреЗрдЯрд╛ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред`);
    } else {
        alert("рдХреЛрдИ рдорддрджрд╛рддрд╛ рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВ рдорд┐рд▓рд╛ред рдХреГрдкрдпрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ EPIC рдирдВрдмрд░ рдФрд░ рдлреЙрд░реНрдореЗрдЯ рд╕рд╣реА рд╣реИред");
    }
}

// ===== Download Functions (Unchanged) =====
function downloadCSV() {
    const csvContent = document.getElementById('csvOutput').textContent;
    if (!csvContent || csvContent.includes('CSV рдбреЗрдЯрд╛ рдпрд╣рд╛рдБ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛')) {
        alert("рдкрд╣рд▓реЗ 'Parse to CSV & JSON' рдмрдЯрди рджрдмрд╛рдХрд░ рдбреЗрдЯрд╛ рдХреЛ Parse рдХрд░реЗрдВред");
        return;
    }
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "voter_list.csv";
    link.click();
}

function downloadJSON() {
    const jsonContent = document.getElementById('jsonOutput').textContent;
    if (!jsonContent || jsonContent.includes('JSON рдбреЗрдЯрд╛ рдпрд╣рд╛рдБ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛')) {
        alert("рдкрд╣рд▓реЗ 'Parse to CSV & JSON' рдмрдЯрди рджрдмрд╛рдХрд░ рдбреЗрдЯрд╛ рдХреЛ Parse рдХрд░реЗрдВред");
        return;
    }
    const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "voter_list.json";
    link.click();
}
</script>
</body>
</html>
