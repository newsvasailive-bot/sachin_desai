<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter List CSV Fixer</title>
<style>
body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 20px; }
h2 { text-align: center; }
textarea { width: 100%; height: 300px; margin-bottom: 10px; padding: 15px; font-size: 14px; border: 1px solid #ccc; box-sizing: border-box; } 
button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
button:hover { background-color: #0056b3; }
pre { background: #fff; padding: 15px; border: 1px solid #ccc; overflow-x: auto; white-space: pre-wrap; margin-top: 15px; }
</style>
</head>
<body>

<h2>Voter List CSV Fixer</h2>
<p>Raw text paste करें, फिर CSV generate करें:</p>
<textarea id="inputText" placeholder="Raw voter text यहाँ paste करें"></textarea>
<br>
<button onclick="generateCSV()">CSV Generate करें</button>

<h3>Output CSV:</h3>
<pre id="outputCSV"></pre>

<script>
function generateCSV() {
    const raw = document.getElementById('inputText').value.trim();
    if (!raw) {
        alert("Text डालें");
        return;
    }

    const lines = raw.split(/\r?\n/);
    const header = 'SerialNo,EPIC_NO,PartNo,VoterName,RelationName,RelationType,HouseNo,Age,Gender';
    let output = header + '\n';
    let serial = 1;

    let voter = {}; 
    let pendingVoterName = ''; 

    function finalizeVoter() {
        if (voter.EPIC_NO) {
            if (!voter.VoterName && pendingVoterName) {
                voter.VoterName = pendingVoterName;
            }

            const row = [
                serial++,
                voter.EPIC_NO || 'NA',
                voter.PartNo || 'NA',
                `"${voter.VoterName ? voter.VoterName.replace(/"/g, '""') : 'NA'}"`,
                `"${voter.RelationName ? voter.RelationName.replace(/"/g, '""') : 'NA'}"`,
                voter.RelationType || 'NA',
                voter.HouseNo || 'NA',
                voter.Age || 'NA',
                voter.Gender || 'NA'
            ].join(',');
            output += row + '\n';
        }
        voter = {}; 
        pendingVoterName = ''; 
    }

    lines.forEach(line => {
        line = line.trim();
        if (!line || line.toLowerCase().includes('photo') || line.toLowerCase().includes('available')) return;
        
        // मतदाता सीरियल नंबर को अनदेखा करें
        if (/^\d+$/.test(line) && line.length < 5) return; 

        // 1. EPIC_NO (नई एंट्री की शुरुआत)
        const epicMatch = line.match(/(\w+)\s+\d{1,3}\/\d{1,3}\/\d+/);
        if (epicMatch) {
            finalizeVoter(); // पिछले वोटर को फाइनल करें

            voter.EPIC_NO = epicMatch[1]; 
            const partMatch = line.match(/\d{1,3}\/\d{1,3}\/\d+/);
            voter.PartNo = partMatch ? partMatch[0] : 'NA';
            
            // यदि नाम EPIC लाइन पर है
            const nameCheck = line.match(/मतदाराचे पूर्ण\s*:\s*(.*)/) || line.match(/मतदा\d+राचे पूर्ण\s*:\s*(.*)/);
            if (nameCheck) {
                 voter.VoterName = nameCheck[1].replace(/नांव\s*/, '').trim();
            }
            return;
        }

        // 2. Voter Name (मतदाराचे पूर्ण)
        const nameMatch = line.match(/मतदाराचे पूर्ण\s*:\s*(.*)/) || line.match(/मतदा\d+राचे पूर्ण\s*:\s*(.*)/);
        if (nameMatch) {
             const name = nameMatch[1].replace(/नांव\s*/, '').trim();
             if (!voter.EPIC_NO) {
                 pendingVoterName = name;
             } else {
                 voter.VoterName = name;
             }
             return;
        }

        // 3. Age/Gender and House Number (अव्यवस्था के कारण एक साथ कैप्चर करना)
        // Age/Gender के लिए Regex (यह Age और Gender को एक साथ कैप्चर करने की कोशिश करता है)
        const detailsMatch = line.match(/(?:वय\s*:\s*(\d+))?\s*(?:.*लिंग\s*:\s*(पु|स्त्री|इतर))?/);
        if (detailsMatch) {
            if (detailsMatch[1] && !voter.Age) voter.Age = detailsMatch[1];
            if (detailsMatch[2]) {
                if (detailsMatch[2].includes('स्त्री')) voter.Gender = 'Female';
                else if (detailsMatch[2].includes('पु')) voter.Gender = 'Male';
                else voter.Gender = 'Other';
            }
        }
        
        // House Number के लिए Regex (घर क्रमांक को वय/लिंग से अलग निकालना)
        const houseMatch = line.match(/घर क्रमांक\s*[:|]\s*(.*?)(?:\s*वय\s*:|\s*लिंग\s*:| Photo|$)/i);
        if (houseMatch) {
            const hn = houseMatch[1].trim();
            voter.HouseNo = hn !== '' ? hn : 'NA';
        }


        // 4. Relation Name & Type
        const relationKeywords = {
            'पतीचे नाव': 'Husband',
            'वडिलांचे नाव': 'Father',
            'आईचे नाव': 'Mother',
            'इतर': 'Other' 
        };

        for (const keyword in relationKeywords) {
            // हम केवल उन लाइनों में खोजते हैं जो स्पष्ट रूप से संबंध नाम से शुरू होती हैं या शामिल करती हैं
            if (line.includes(keyword)) {
                // संबंध नाम कीवर्ड के बाद कॉलन या पाइप (|) के बाद नाम निकालें
                const nameMatch = line.match(new RegExp(`${keyword}\\s*[:|]\\s*(.*?)(?:घर क्रमांक|वय|लिंग|Photo|$|\\|)`, 'i'));
                if (nameMatch && nameMatch[1].trim()) {
                    voter.RelationName = nameMatch[1].trim();
                    voter.RelationType = relationKeywords[keyword];
                    return; 
                }
            }
        }
    });

    // अंतिम वोटर को फाइनल करें
    finalizeVoter();

    document.getElementById('outputCSV').textContent = output;
}
</script>

</body>
</html>
