<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter List Parser & Firebase</title>
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-database-compat.js"></script>
<style>
body { font-family: Arial; padding:20px; background:#f9f9f9; }
textarea { width:100%; height:200px; margin-bottom:10px; }
button { padding:10px 20px; margin:5px; cursor:pointer; }
pre { background:#eee; padding:10px; overflow-x:auto; white-space: pre-wrap; }
</style>
</head>
<body>

<h2>Voter List Parser & Firebase Upload</h2>

<textarea id="voterText" placeholder="Raw voter text paste here..."></textarea>
<br>
<button onclick="parseVoters()">Parse to CSV & JSON</button>
<button onclick="downloadCSV()">Download CSV</button>
<button onclick="downloadJSON()">Download JSON</button>
<button onclick="pushFirebase()">Send to Firebase</button>

<h3>CSV Output:</h3>
<pre id="csvOutput"></pre>

<h3>JSON Output:</h3>
<pre id="jsonOutput"></pre>

<script>
// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw",
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== Parsing Logic =====
let voters = [];

function cleanText(str) {
    if(!str) return '';
    return str.replace(/(नांव|Available|Photo)/g,'').replace(/\r?\n/g,' ').trim();
}

function parseVoters() {
    const text = document.getElementById('voterText').value;
    const lines = text.split(/\r?\n/);
    voters = [];
    let serial = 1;
    let current = {};

    lines.forEach(line => {
        line = line.trim();
        if(!line) return;

        // EPIC_NO & PartNo
        const epicMatch = line.match(/RBG\d+\s+[\d\/]+/);
        if(epicMatch) {
            if(Object.keys(current).length) voters.push(current);
            const parts = epicMatch[0].split(/\s+/);
            current = {
                SerialNo: serial++,
                EPIC_NO: parts[0],
                PartNo: parts[1] || '',
                VoterName: '',
                RelationName: '',
                RelationType: '',
                HouseNo: '',
                Age: '',
                Gender: ''
            };
        }

        // VoterName
        if(line.startsWith('| मतदाराचे पूर्ण') || line.startsWith('मतदाराचे पूर्ण')) {
            const name = cleanText(line.split(':')[1]);
            if(name) current.VoterName = name;
        }

        // Relation
        if(line.startsWith('| पतीचे नाव') || line.startsWith('पतीचे नाव')) {
            const name = cleanText(line.split(':')[1]);
            if(name) {
                current.RelationName = name;
                current.RelationType = 'Husband';
            }
        }
        if(line.startsWith('| वडिलांचे नाव') || line.startsWith('वडिलांचे नाव')) {
            const name = cleanText(line.split(':')[1]);
            if(name) {
                current.RelationName = name;
                current.RelationType = 'Father';
            }
        }

        // HouseNo
        if(line.startsWith('| घर क्रमांक') || line.startsWith('घर क्रमांक')) {
            const house = cleanText(line.split(':')[1]);
            if(house) current.HouseNo = house;
        }

        // Age
        if(line.startsWith('| वय') || line.startsWith('वय')) {
            const ageMatch = line.match(/\d+/);
            if(ageMatch) current.Age = ageMatch[0];
        }

        // Gender
        if(line.startsWith('| लिंग') || line.startsWith('लिंग')) {
            const g = line.split(':')[1]?.trim();
            if(g) current.Gender = (g.startsWith('पु'))?'Male':(g.startsWith('स्त्री')?'Female':'');
        }
    });

    if(Object.keys(current).length) voters.push(current);

    // ===== CSV =====
    const escapeCSV = str => `"${String(str || '').replace(/"/g,'""').replace(/\n/g,' ').replace(/\r/g,' ')}"`;
    const csvHeader = 'SerialNo,EPIC_NO,PartNo,VoterName,RelationName,RelationType,HouseNo,Age,Gender';
    const csvRows = voters.map(v => [
        v.SerialNo, v.EPIC_NO, v.PartNo, 
        escapeCSV(v.VoterName), escapeCSV(v.RelationName), v.RelationType, 
        escapeCSV(v.HouseNo), v.Age, v.Gender
    ].join(','));
    document.getElementById('csvOutput').textContent = [csvHeader, ...csvRows].join('\n');

    // ===== JSON =====
    document.getElementById('jsonOutput').textContent = JSON.stringify(voters, null, 2);
}

// ===== Download Functions =====
function downloadCSV() {
    const csvContent = document.getElementById('csvOutput').textContent;
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "voter_list.csv";
    link.click();
}

function downloadJSON() {
    const jsonContent = document.getElementById('jsonOutput').textContent;
    const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "voter_list.json";
    link.click();
}

// ===== Firebase Push =====
function pushFirebase() {
    let success = 0, fail = 0;
    voters.forEach(v => {
        try {
            const key = v.EPIC_NO + '_' + v.PartNo; // unique key
            db.ref('voters/' + key).set(v);
            success++;
        } catch(e) {
            fail++;
            console.error('Firebase Error:', e);
        }
    });
    alert(`Voters uploaded! Success: ${success}, Fail: ${fail}`);
}
</script>
</body>
</html>
