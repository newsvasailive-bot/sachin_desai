<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter List Parser & Firebase Uploader</title>
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-database-compat.js"></script>
<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f9f9f9; }
textarea { width:100%; height:200px; margin-bottom:10px; border: 1px solid #ccc; padding: 10px; box-sizing: border-box; }
button { padding:10px 20px; margin:5px 5px 5px 0; cursor:pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; transition: background-color 0.3s; }
button:hover { background-color: #0056b3; }
pre { background:#eee; padding:10px; overflow-x:auto; white-space: pre-wrap; border: 1px solid #ddd; border-radius: 4px; }
h2, h3 { color: #333; }
.warning { color: red; font-weight: bold; margin-top: 15px; border: 1px solid red; padding: 10px; background: #ffebeb; border-radius: 4px; }
</style>
</head>
<body>

<h2>ЁЯЧ│я╕П рд╡реЛрдЯрд░ рд▓рд┐рд╕реНрдЯ рдкрд╛рд░реНрд╕рд░ рдФрд░ рдлрд╛рдпрд░рдмреЗрд╕ рдЕрдкрд▓реЛрдб</h2>

<p>рдХрдЪреНрдЪрд╛ (Raw) рд╡реЛрдЯрд░ рд▓рд┐рд╕реНрдЯ рдЯреЗрдХреНрд╕реНрдЯ рдпрд╣рд╛рдБ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ:</p>
<textarea id="voterText" placeholder="рдЙрджрд╛рд╣рд░рдг: 
...
RBG1234567 15/234
рдорддрджрд╛рд░рд╛рдЪреЗ рдкреВрд░реНрдг рдирд╛рдВрд╡ : рд░рдореЗрд╢ рд╕реБрд░реЗрд╢ рдкрд╛рдЯрд┐рд▓ Available Photo
рд╡рдбрд┐рд▓рд╛рдВрдЪреЗ рдирд╛рд╡ : рд╕реБрд░реЗрд╢ рдмрд╛рдмреБрд░рд╛рд╡ рдкрд╛рдЯрд┐рд▓
рдШрд░ рдХреНрд░рдорд╛рдВрдХ : 15
рд╡рдп : 45
рд▓рд┐рдВрдЧ : рдкреБ
..."></textarea>
<br>

<button onclick="parseVoters()">1. Parse to CSV & JSON</button>
<button onclick="downloadCSV()">2. Download CSV</button>
<button onclick="downloadJSON()">3. Download JSON</button>
<button onclick="pushFirebase()">4. Send to Firebase</button>

<div class="warning">
    ЁЯЫС **рдЬрд╝рд░реВрд░реА рдЪреЗрддрд╛рд╡рдиреА:** рдмрдЯрди 4 (`Send to Firebase`) рддрднреА рдХрд╛рдо рдХрд░реЗрдЧрд╛ рдЬрдм рдЖрдк рдиреАрдЪреЗ рджрд┐рдП рдЧрдП `firebaseConfig` рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рдЕрдкрдиреЗ **рдЕрд╕рд▓реА рдлрд╛рдпрд░рдмреЗрд╕ рдбреЗрдЯрд╛** рд╕реЗ рдмрджрд▓реЗрдВрдЧреЗред
</div>

<h3>CSV Output:</h3>
<pre id="csvOutput">CSV рдбреЗрдЯрд╛ рдпрд╣рд╛рдБ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛...</pre>

<h3>JSON Output:</h3>
<pre id="jsonOutput">JSON рдбреЗрдЯрд╛ рдпрд╣рд╛рдБ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛...</pre>

<script>
// =================================================================
// ===== ЁЯЫС FIREBASE CONFIGURATION (CHANGE THIS!) ЁЯЫС =====
// =================================================================
// рдЗрди рдбрдореА рд╡реИрд▓реНрдпреВ рдХреЛ Firebase Console рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдЕрдкрдиреЗ рдЕрд╕рд▓реА KEYS рд╕реЗ рдмрджрд▓реЗрдВред
const firebaseConfig = {
  apiKey: "AIzaSyCdjqVFKOQ1dtaXCGFUUtsJWbFdGNTo-xw", 
  authDomain: "voter-25c94.firebaseapp.com",
  databaseURL: "https://voter-25c94-default-rtdb.firebaseio.com",
  projectId: "voter-25c94",
  storageBucket: "voter-25c94.appspot.com",
  messagingSenderId: "297773534400",
  appId: "1:297773534400:web:3722c487b8c83e9b787125"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== Parsing Logic =====
let voters = [];

/**
 * рдкрд╛рда рд╕реЗ рдЕрдирд╛рд╡рд╢реНрдпрдХ рд╢рдмреНрдж рдФрд░ рдлреЙрд░реНрдореЗрдЯрд┐рдВрдЧ рд╣рдЯрд╛рддрд╛ рд╣реИред
 */
function cleanText(str) {
    if(!str) return '';
    // REGEX рдХреЛ рдФрд░ рдордЬрдмреВрдд рдХрд┐рдпрд╛ рдЧрдпрд╛
    return str.replace(/(рдирд╛рдВрд╡|Available|Photo|рдорддрджрд╛рд░рд╛рдЪреЗ|рдЙрдкрд▓рдмреНрдз|рдкреВрд░реНрдг|рдкрддреАрдЪреЗ|рд╡рдбрд┐рд▓рд╛рдВрдЪреЗ|:\s*)$/gi,'')
              .replace(/\r?\n/g,' ')
              .trim()
              .replace(/^\s*:\s*/, ''); // рдпрджрд┐ рд╢реБрд░реВ рдореЗрдВ ':' рд╣реИ рддреЛ рд╣рдЯрд╛ рджреЗрдВ
}

/**
 * рдХрдЪреНрдЪреЗ рдкрд╛рда рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рддрд╛ рд╣реИ рдФрд░ CSV/JSON рдореЗрдВ рдЖрдЙрдЯрдкреБрдЯ рдХрд░рддрд╛ рд╣реИред
 */
function parseVoters() {
    const text = document.getElementById('voterText').value;
    const lines = text.split(/\r?\n/);
    voters = [];
    let serial = 1;
    let current = {};

    lines.forEach(line => {
        line = line.trim();
        if(!line) return;

        // EPIC_NO & PartNo: рдирдП рдорддрджрд╛рддрд╛ рд░рд┐рдХреЙрд░реНрдб рдХреА рд╢реБрд░реБрдЖрддред
        // EPIC рдирдВрдмрд░ рдФрд░ Part Number (digits/digits) рдХреЛ рдореИрдЪ рдХрд░рддрд╛ рд╣реИред
        const epicMatch = line.match(/([A-Z0-9]{3,})\s+([\d\/]+)/); 
        if(epicMatch) {
            // рдкрд┐рдЫрд▓реЗ рд░рд┐рдХреЙрд░реНрдб рдХреЛ рдкреБрд╢ рдХрд░реЗрдВ
            if(Object.keys(current).length) voters.push(current);
            current = {
                SerialNo: serial++,
                EPIC_NO: epicMatch[1], 
                PartNo: epicMatch[2] || '', 
                VoterName: '',
                RelationName: '',
                RelationType: '',
                HouseNo: '',
                Age: '',
                Gender: ''
            };
        }

        // --- FIXED/ROBUST FIELD EXTRACTION USING REGEX ---
        
        // VoterName (рдорддрджрд╛рд░рд╛рдЪреЗ рдкреВрд░реНрдг)
        const nameMatch = line.match(/(?:\|?\s*(?:рдорддрджрд╛рд░рд╛рдЪреЗ рдкреВрд░реНрдг|Voter's Full)\s*рдирд╛рдВрд╡?\s*:\s*)(.*)/i);
        if (nameMatch && nameMatch[1]) {
            current.VoterName = cleanText(nameMatch[1]);
        }

        // Relation (рдкрддреАрдЪреЗ/рд╡рдбрд┐рд▓рд╛рдВрдЪреЗ рдирд╛рд╡)
        const relationMatch = line.match(/(?:\|?\s*(рдкрддреАрдЪреЗ|рд╡рдбрд┐рд▓рд╛рдВрдЪреЗ)\s*рдирд╛рд╡\s*:\s*)(.*)/i);
        if (relationMatch && relationMatch[2]) {
            current.RelationName = cleanText(relationMatch[2]);
            current.RelationType = (relationMatch[1] === 'рдкрддреАрдЪреЗ') ? 'Husband' : 'Father';
        }

        // HouseNo (рдШрд░ рдХреНрд░рдорд╛рдВрдХ)
        const houseMatch = line.match(/(?:\|?\s*рдШрд░ рдХреНрд░рдорд╛рдВрдХ\s*:\s*)(.*)/i);
        if (houseMatch && houseMatch[1]) {
            current.HouseNo = cleanText(houseMatch[1]);
        }
        
        // Age (рд╡рдп)
        const ageMatch = line.match(/рд╡рдп\s*:\s*(\d+)/);
        if(ageMatch) {
            current.Age = ageMatch[1];
        }

        // Gender (рд▓рд┐рдВрдЧ)
        const genderMatch = line.match(/рд▓рд┐рдВрдЧ\s*:\s*(рдкреБ|рд╕реНрддреНрд░реА|Male|Female)/i);
        if(genderMatch) {
            const g = genderMatch[1].trim();
            if(g.startsWith('рдкреБ') || g.startsWith('Ma')) current.Gender = 'Male';
            else if(g.startsWith('рд╕реНрддреНрд░реА') || g.startsWith('Fe')) current.Gender = 'Female';
        }
    });

    // рдЕрдВрддрд┐рдо рд░рд┐рдХреЙрд░реНрдб рдХреЛ рдкреБрд╢ рдХрд░реЗрдВ
    if(Object.keys(current).length) voters.push(current);

    // ===== CSV Output Generation =====
    const escapeCSV = str => `"${String(str || '').replace(/"/g,'""').replace(/\n/g,' ').replace(/\r/g,' ')}"`;
    const csvHeader = 'SerialNo,EPIC_NO,PartNo,VoterName,RelationName,RelationType,HouseNo,Age,Gender';
    const csvRows = voters.map(v => [
        v.SerialNo, v.EPIC_NO, v.PartNo, 
        escapeCSV(v.VoterName), escapeCSV(v.RelationName), v.RelationType, 
        escapeCSV(v.HouseNo), v.Age, v.Gender
    ].join(','));
    document.getElementById('csvOutput').textContent = [csvHeader, ...csvRows].join('\n');

    // ===== JSON Output Generation =====
    document.getElementById('jsonOutput').textContent = JSON.stringify(voters, null, 2);
}

// ===== Download Functions =====
function downloadCSV() {
    const csvContent = document.getElementById('csvOutput').textContent;
    if (!csvContent || csvContent.includes('CSV рдбреЗрдЯрд╛ рдпрд╣рд╛рдБ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛')) {
        alert("рдкрд╣рд▓реЗ 'Parse to CSV & JSON' рдмрдЯрди рджрдмрд╛рдХрд░ рдбреЗрдЯрд╛ рдХреЛ Parse рдХрд░реЗрдВред");
        return;
    }
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "voter_list.csv";
    link.click();
}

function downloadJSON() {
    const jsonContent = document.getElementById('jsonOutput').textContent;
    if (!jsonContent || jsonContent.includes('JSON рдбреЗрдЯрд╛ рдпрд╣рд╛рдБ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛')) {
        alert("рдкрд╣рд▓реЗ 'Parse to CSV & JSON' рдмрдЯрди рджрдмрд╛рдХрд░ рдбреЗрдЯрд╛ рдХреЛ Parse рдХрд░реЗрдВред");
        return;
    }
    const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "voter_list.json";
    link.click();
}

// ===== Firebase Push =====
function pushFirebase() {
    if (voters.length === 0 || !document.getElementById('jsonOutput').textContent.includes('[')) {
        alert("рдкрд╣рд▓реЗ 'Parse to CSV & JSON' рдмрдЯрди рджрдмрд╛рдХрд░ рдбреЗрдЯрд╛ рдХреЛ Parse рдХрд░реЗрдВред");
        return;
    }
    
    let success = 0, fail = 0;
    
    // рд╕рднреА Firebase рдЕрдкрд▓реЛрдб рдкреНрд░реЙрдорд┐рд╕реЗрд╕ рдХреЛ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдРрд░реЗ
    const pushPromises = [];

    voters.forEach(v => {
        if (!v.EPIC_NO || !v.PartNo) {
            console.warn('Skipping record due to missing EPIC_NO or PartNo:', v);
            fail++;
            return;
        }
        
        try {
            // Unique Key for Firebase (Forward slash / is replaced with - for path safety)
            const key = v.EPIC_NO + '_' + v.PartNo.replace(/\//g, '-'); 
            
            // Promise рдХреЛ рдРрд░реЗ рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ
            const promise = db.ref('voters/' + key).set(v)
                .then(() => success++)
                .catch(e => {
                    fail++;
                    console.error('Firebase Error for key ' + key + ':', e);
                });
            pushPromises.push(promise);
            
        } catch(e) {
            fail++;
            console.error('Local Push Error:', e);
        }
    });

    // рд╕рднреА рдЕрдкрд▓реЛрдб рдкреНрд░реЙрдорд┐рд╕реЗрд╕ рдХреЗ рдЦрддреНрдо рд╣реЛрдиреЗ рдХрд╛ рдЗрдВрддрдЬрд╛рд░ рдХрд░реЗрдВ
    Promise.allSettled(pushPromises).then(() => {
        alert(`рд╡реЛрдЯрд░ рдЕрдкрд▓реЛрдб рдкреВрд░рд╛ рд╣реБрдЖ! Success attempts: ${success}, Failed records: ${fail}`);
    });
}
</script>
</body>
</html>
