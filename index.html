<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voter List CSV Fixer - Fixed Header</title>
<style>
body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 20px; }
h2 { text-align: center; color: #333; }
p { text-align: center; }
textarea { 
    width: 100%; 
    height: 350px; 
    margin-bottom: 15px; 
    padding: 15px; 
    font-size: 14px; 
    border: 2px solid #ccc; 
    box-sizing: border-box; 
    resize: vertical;
} 
.button-container {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 20px;
}
.button-container button {
    padding: 12px 15px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    transition: background-color 0.3s;
    width: 100%;
}
#generateButton {
    background-color: #007bff; /* рдиреАрд▓рд╛ */
    color: white;
}
#generateButton:hover { background-color: #0056b3; }

#copyButton {
    background-color: #28a745; /* рд╣рд░рд╛ */
    color: white;
}
#copyButton:hover { background-color: #218838; }

#outputCSV {
    width: 100%; 
    height: 300px; 
    padding: 10px; 
    font-family: Consolas, monospace;
    font-size: 13px;
    border: 1px solid #ddd;
    box-sizing: border-box;
    white-space: pre-wrap;
}
</style>
</head>
<body>

<h2>Voter List CSV Fixer ЁЯЪА (Final Solution)</h2>
<p>Raw voter text рдпрд╣рд╛рдБ paste рдХрд░реЗрдВ:</p>
<textarea id="inputText" placeholder="рдХрдЪреНрдЪрд╛ рдЯреЗрдХреНрд╕реНрдЯ рдпрд╣рд╛рдБ рдкреЗрд╕реНрдЯ рдХрд░реЗрдВ"></textarea>

<div class="button-container">
    <button id="generateButton" onclick="generateCSV()">CSV Generate рдХрд░реЗрдВ</button>
    <button id="copyButton" onclick="copyCSV()" disabled>ЁЯУЛ CSV рдХреЙрдкреА рдХрд░реЗрдВ</button>
</div>

<h3>Output CSV:</h3>
<textarea id="outputCSV" readonly placeholder="рдЬрдирд░реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ CSV рдпрд╣рд╛рдБ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛ред"></textarea>

<script>
// =======================================================================
// CSV GENERATION LOGIC - CUSTOMIZED FOR YOUR DATA
// =======================================================================
const FIXED_HEADER = 'SerialNo,EPIC_NO,PartNo,VoterName,RelationName,RelationType,HouseNo,Age,Gender';

function generateCSV() {
    const raw = document.getElementById('inputText').value.trim();
    const outputElement = document.getElementById('outputCSV');
    const copyButton = document.getElementById('copyButton');
    
    copyButton.disabled = true;

    if (!raw) {
        outputElement.value = FIXED_HEADER + '\n' + "тЭМ рддреНрд░реБрдЯрд┐: рдХреГрдкрдпрд╛ рдЯреЗрдХреНрд╕реНрдЯ рдбрд╛рд▓реЗрдВред";
        return;
    }

    // 1. рд╕рднреА рдкрд╛рдЗрдк, рд▓рд╛рдЗрди рдмреНрд░реЗрдХ рдФрд░ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реНрдкреЗрд╕ рдХреЛ рд╣рдЯрд╛рдХрд░ рдбреЗрдЯрд╛ рдХреЛ рд╕рдореЗрдЯреЗрдВ
    // 'рдорддрджрд╛...' рдкреИрдЯрд░реНрди рдХреЛ рдЯреВрдЯрдиреЗ рд╕реЗ рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╣рд▓реЗ рд╣реА рд╕реНрдкреЗрд╕ рд╣рдЯрд╛ рджреЗрдВ
    const cleanedRaw = raw
        .replace(/\|\s*рдорддрджрд╛/g, ' рдорддрджрд╛') // рдкрд╛рдЗрдк + рд╕реНрдкреЗрд╕ + рдорддрджрд╛ рдХреЛ рд╕реНрдкреЗрд╕ + рдорддрджрд╛ рд╕реЗ рдмрджрд▓реЗрдВ
        .replace(/\|\s*/g, ' ') 
        .replace(/\s+/g, ' ') // рдХрдИ рд╕реНрдкреЗрд╕ рдХреЛ рд╕рд┐рдВрдЧрд▓ рд╕реНрдкреЗрд╕ рд╕реЗ рдмрджрд▓реЗрдВ
        .replace(/\n/g, ' ') // рд▓рд╛рдЗрди рдмреНрд░реЗрдХ рдХреЛ рд╕реНрдкреЗрд╕ рд╕реЗ рдмрджрд▓реЗрдВ
        .trim();
    
    // 2. рд╕рднреА EPIC рдирдВрдмрд░реЛрдВ рдХреЛ рдвреВрдВрдвреЗрдВ
    // EPIC рдкреИрдЯрд░реНрди: рдЕрдХреНрд╖рд░ рдФрд░ рд╕рдВрдЦреНрдпрд╛ (\w{7,}) рдЙрд╕рдХреЗ рдмрд╛рдж рд╡реИрдХрд▓реНрдкрд┐рдХ PartNo
    const epicRegex = /(\w{7,})\s*(\d{1,3}\/\d{1,3}\/\d+)/g; 

    let matches = [...cleanedRaw.matchAll(epicRegex)];
    
    if (matches.length === 0) {
        outputElement.value = FIXED_HEADER + '\n' + "тЭМ рдЧрдВрднреАрд░ рддреНрд░реБрдЯрд┐: рдХреЛрдИ EPIC рдкреИрдЯрд░реНрди ('RBG1234567 1/1/1') рдЯреЗрдХреНрд╕реНрдЯ рдореЗрдВ рдирд╣реАрдВ рдорд┐рд▓рд╛ред";
        return;
    }
    
    let output = FIXED_HEADER + '\n';
    let serial = 1;

    // 3. рдбреЗрдЯрд╛ рдХреЛ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░реЗрдВ (рдкреНрд░рддреНрдпреЗрдХ EPIC рдореИрдЪ рдкрд░ рд▓реВрдк рдХрд░реЗрдВ)
    for (let i = 0; i < matches.length; i++) {
        const start = matches[i].index;
        const end = (i + 1 < matches.length) ? matches[i+1].index : cleanedRaw.length;
        
        // рдпрд╣ 'fullRecord' рдПрдХ EPIC рд╕реЗ рд╢реБрд░реВ рд╣реЛрдХрд░ рдЕрдЧрд▓реЗ EPIC рддрдХ рдХрд╛ рд╕рд╛рд░рд╛ рдЯреЗрдХреНрд╕реНрдЯ рд╣реИ
        const fullRecord = cleanedRaw.substring(start, end).trim();
        
        let voter = {};
        
        // 1. EPIC_NO and PartNo
        voter.EPIC_NO = matches[i][1];
        voter.PartNo = matches[i][2];
        
        // 2. Voter Name (рдЯреВрдЯреЗ рд╣реБрдП рдорддрджрд╛571... рдХреЛ рд╕рдВрднрд╛рд▓реЗрдВ)
        const nameMatch = fullRecord.match(/рдорддрджрд╛\s*\d*рд░рд╛рдЪреЗ рдкреВрд░реНрдг\s*:\s*(.*?)\s*рдирд╛рдВрд╡/i);
        voter.VoterName = nameMatch ? nameMatch[1].trim() : 'NA';
        // рдпрджрд┐ рдирд╛рдо NA рд╣реИ, рддреЛ рдкреВрд░реЗ рд░рд┐рдХреЙрд░реНрдб рд╕реЗ рдкрд╣рд▓рд╛ рд╢рдмреНрдж рдирд┐рдХрд╛рд▓реЗрдВ (рдЬреИрд╕реЗ 'рд╡рд┐рд╢реНрд╡рдХрд░реНрдорд╛')
        if (voter.VoterName === 'NA') {
             const fallbackMatch = fullRecord.match(/RBG\w+\s*\d{1,3}\/\d{1,3}\/\d+\s*(\d{1,3})?\s*(.*?)\s*рд╡рдбрд┐рд▓рд╛рдВрдЪреЗ|рдкрддреАрдЪреЗ|рдЖрдИрдЪреЗ/i);
             voter.VoterName = fallbackMatch && fallbackMatch[2] ? fallbackMatch[2].trim() : 'NA';
        }


        // 3. Relation Name and Type
        const relationKeywords = {
            'рдкрддреАрдЪреЗ рдирд╛рд╡': 'Husband',
            'рд╡рдбрд┐рд▓рд╛рдВрдЪреЗ рдирд╛рд╡': 'Father',
            'рдЖрдИрдЪреЗ рдирд╛рд╡': 'Mother'
        };
        voter.RelationName = 'NA';
        voter.RelationType = 'NA';

        for (const keyword in relationKeywords) {
             // рд░рд┐рд▓реЗрд╢рди рдиреЗрдо рдХреЛ рдЕрдЧрд▓реЗ рдХреАрд╡рд░реНрдб рдпрд╛ рдбрд┐рдЯреЗрд▓реНрд╕ рддрдХ рдХреИрдкреНрдЪрд░ рдХрд░реЗрдВ
             const relationRegex = new RegExp(`${keyword}\\s*[:|]\\s*(.*?)(?:рдШрд░ рдХреНрд░рдорд╛рдВрдХ|рд╡рдп|рд▓рд┐рдВрдЧ|рдорддрджрд╛|Photo|${voter.EPIC_NO}|$)`, 'i');
             const relationMatch = fullRecord.match(relationRegex);
             
             if (relationMatch && relationMatch[1].trim()) {
                 voter.RelationName = relationMatch[1].trim();
                 voter.RelationType = relationKeywords[keyword];
                 break;
             }
        }
        
        // 4. Age and Gender
        const detailsMatch = fullRecord.match(/рд╡рдп\s*:\s*(\d+).*рд▓рд┐рдВрдЧ\s*:\s*(рдкреБ|рд╕реНрддреНрд░реА|рдЗрддрд░)/);
        if (detailsMatch) {
            voter.Age = detailsMatch[1];
            if (detailsMatch[2].includes('рд╕реНрддреНрд░реА')) voter.Gender = 'Female';
            else if (detailsMatch[2].includes('рдкреБ')) voter.Gender = 'Male';
            else voter.Gender = 'Other';
        } else {
            voter.Age = 'NA';
            voter.Gender = 'NA';
        }

        // 5. House Number
        // рдШрд░ рдХреНрд░рдорд╛рдВрдХ рдХреЛ рдЕрдЧрд▓реЗ рдкреНрд░рдореБрдЦ рдХреАрд╡рд░реНрдб рдпрд╛ Photo рддрдХ рдХреИрдкреНрдЪрд░ рдХрд░реЗрдВ
        const houseMatch = fullRecord.match(/рдШрд░ рдХреНрд░рдорд╛рдВрдХ\s*[:|]\s*(.*?)(?:\s*рд╡рдп\s*:|\s*рд▓рд┐рдВрдЧ\s*:| Photo|$)/i);
        voter.HouseNo = houseMatch ? houseMatch[1].trim() : 'NA';
        
        // 6. CSV Row Output
        const row = [
            serial++,
            voter.EPIC_NO || 'NA',
            voter.PartNo || 'NA',
            `"${voter.VoterName ? voter.VoterName.replace(/"/g, '""') : 'NA'}"`,
            `"${voter.RelationName || 'NA'}"`,
            voter.RelationType || 'NA',
            voter.HouseNo || 'NA',
            voter.Age || 'NA',
            voter.Gender || 'NA'
        ].join(',');
        output += row + '\n';
    }

    outputElement.value = output;
    copyButton.disabled = false;
}

// =======================================================================
// COPY FUNCTION
// =======================================================================
function copyCSV() {
    const outputElement = document.getElementById('outputCSV');
    outputElement.select();
    outputElement.setSelectionRange(0, 99999);
    
    navigator.clipboard.writeText(outputElement.value).then(() => {
        const copyButton = document.getElementById('copyButton');
        copyButton.textContent = 'тЬЕ рдХреЙрдкреА рд╣реЛ рдЧрдпрд╛!';
        setTimeout(() => {
            copyButton.textContent = 'ЁЯУЛ CSV рдХреЙрдкреА рдХрд░реЗрдВ';
        }, 1500);
    }).catch(err => {
        alert('рдХреЙрдкреА рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓: ' + err);
    });
}
</script>

</body>
</html>
