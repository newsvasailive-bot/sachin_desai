<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Messy Voter Data ‚Üí CSV</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
h2 { text-align: center; color: #333; }
textarea { width: 100%; height: 300px; padding: 10px; margin-bottom: 15px; font-size: 14px; resize: vertical; }
.button-container { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
button { flex: 1; padding: 12px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; transition: .3s; }
#generateButton { background: #007bff; } #generateButton:hover { background: #0056b3; }
#copyButton { background: #28a745; } #copyButton:hover { background: #218838; }
#downloadButton { background: #ffc107; color: #000; } #downloadButton:hover { background: #e0a800; }
#outputCSV { width:100%; height:300px; padding:10px; font-family: Consolas, monospace; font-size:13px; border:1px solid #ddd; box-sizing:border-box; white-space: pre-wrap; }
</style>
</head>
<body>

<h2>Messy Voter Data ‚Üí CSV üöÄ</h2>
<textarea id="inputText" placeholder="Raw messy voter text paste ‡§ï‡§∞‡•á‡§Ç..."></textarea>

<div class="button-container">
<button id="generateButton">CSV Generate ‡§ï‡§∞‡•á‡§Ç</button>
<button id="copyButton" disabled>üìã Copy CSV</button>
<button id="downloadButton" disabled>‚¨áÔ∏è Download CSV</button>
</div>

<h3>Generated CSV:</h3>
<textarea id="outputCSV" readonly placeholder="CSV output ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ..."></textarea>

<script>
// Helper function to quote fields with comma or quotes
function quoteCSVField(field){
    if(!field) field = "NA";
    field = field.toString().trim();
    if(field.includes(",") || field.includes('"') || field.includes("\n")){
        field = '"' + field.replace(/"/g,'""') + '"';
    }
    return field;
}

function generateCSVFromMessyText(text){
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l!=="");
    const csvRows = [];
    const header = ["SerialNo","EPIC_NO","PartNo","VoterName","RelationName","RelationType","HouseNo","Age","Gender"];
    csvRows.push(header.join(","));

    let currentSerial = "";
    let currentEPIC = "";
    let currentPart = "";
    let voterName = "";
    let relationName = "";
    let relationType = "";
    let houseNo = "";
    let age = "";
    let gender = "";

    for(let line of lines){
        // Check if line starts with SerialNo (number)
        const serialMatch = line.match(/^(\d{1,4})\s*[, ]/);
        if(serialMatch){
            // Push previous voter if exists
            if(currentSerial || voterName){
                csvRows.push([
                    quoteCSVField(currentSerial),
                    quoteCSVField(currentEPIC),
                    quoteCSVField(currentPart),
                    quoteCSVField(voterName),
                    quoteCSVField(relationName),
                    quoteCSVField(relationType),
                    quoteCSVField(houseNo),
                    quoteCSVField(age),
                    quoteCSVField(gender)
                ].join(","));
            }
            // Reset fields
            currentSerial = serialMatch[1];
            currentEPIC = "";
            currentPart = "";
            voterName = "";
            relationName = "";
            relationType = "";
            houseNo = "";
            age = "";
            gender = "";
            // Extract EPIC_NO and PartNo if present
            const epcMatch = line.match(/(RBG\d{7,8})\s*(\d{1,3}\/\d{1,3}\/\d{1,3})?/);
            if(epcMatch){
                currentEPIC = epcMatch[1];
                currentPart = epcMatch[2] || "";
            }
            // Try to extract voterName
            const nameMatch = line.match(/\d{1,3}\s*(‡§Æ‡§§‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§™‡•Ç‡§∞‡•ç‡§£:)?\s*(.*)/i);
            if(nameMatch){
                voterName = nameMatch[2].trim();
            }
            continue;
        }

        // Lines with EPIC_NO or PartNo
        if(line.startsWith("RBG")){
            const parts = line.split(" ");
            currentEPIC = parts[0].trim();
            currentPart = parts.slice(1).join(" ").trim();
            continue;
        }

        // Lines containing voter name
        if(line.toLowerCase().includes("‡§Æ‡§§‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§™‡•Ç‡§∞‡•ç‡§£") || line.match(/^\|/)){
            voterName = line.replace(/.*‡§Æ‡§§‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§™‡•Ç‡§∞‡•ç‡§£:?\s*/i,"").trim();
            continue;
        }

        // Relation
        if(line.toLowerCase().includes("‡§Ü‡§à‡§ö‡•á ‡§®‡§æ‡§µ") || line.toLowerCase().includes("‡§™‡§§‡•Ä‡§ö‡•á ‡§®‡§æ‡§µ") || line.toLowerCase().includes("‡§µ‡§°‡§ø‡§≤‡§æ‡§Ç‡§ö‡•á ‡§®‡§æ‡§µ")){
            relationName = line.split(":")[1]?.trim() || "";
            if(line.toLowerCase().includes("‡§Ü‡§à‡§ö‡•á ‡§®‡§æ‡§µ")) relationType="Mother";
            else if(line.toLowerCase().includes("‡§™‡§§‡•Ä‡§ö‡•á ‡§®‡§æ‡§µ")) relationType="Husband";
            else if(line.toLowerCase().includes("‡§µ‡§°‡§ø‡§≤‡§æ‡§Ç‡§ö‡•á ‡§®‡§æ‡§µ")) relationType="Father";
            continue;
        }

        // Age
        if(line.toLowerCase().includes("‡§µ‡§Ø")){
            age = line.replace(/‡§µ‡§Ø\s*:\s*/i,"").trim();
            continue;
        }

        // Gender
        if(line.toLowerCase().includes("‡§≤‡§ø‡§Ç‡§ó")){
            const g = line.replace(/.*‡§≤‡§ø‡§Ç‡§ó\s*:\s*/i,"").trim();
            if(g.includes("‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä")) gender="Female";
            else if(g.includes("‡§™‡•Å‡§∞‡•Ç")) gender="Male";
            else gender = g;
            continue;
        }

        // HouseNo
        if(line.toLowerCase().includes("‡§ò‡§∞ ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï")){
            houseNo = line.replace(/.*‡§ò‡§∞ ‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï\s*:?/i,"").trim();
            continue;
        }
    }

    // Push last record
    if(currentSerial || voterName){
        csvRows.push([
            quoteCSVField(currentSerial),
            quoteCSVField(currentEPIC),
            quoteCSVField(currentPart),
            quoteCSVField(voterName),
            quoteCSVField(relationName),
            quoteCSVField(relationType),
            quoteCSVField(houseNo),
            quoteCSVField(age),
            quoteCSVField(gender)
        ].join(","));
    }

    return csvRows.join("\n");
}

document.getElementById("generateButton").addEventListener("click", ()=>{
    const input = document.getElementById("inputText").value;
    if(!input.trim()){ alert("Raw voter text paste ‡§ï‡§∞‡•á‡§Ç!"); return; }
    const csv = generateCSVFromMessyText(input);
    document.getElementById("outputCSV").value = csv;
    document.getElementById("copyButton").disabled = false;
    document.getElementById("downloadButton").disabled = false;
});

document.getElementById("copyButton").addEventListener("click", ()=>{
    const output = document.getElementById("outputCSV");
    output.select();
    document.execCommand("copy");
    alert("CSV clipboard ‡§Æ‡•á‡§Ç copy ‡§π‡•ã ‡§ó‡§Ø‡§æ! üìã");
});

document.getElementById("downloadButton").addEventListener("click", ()=>{
    const csvData = document.getElementById("outputCSV").value;
    const blob = new Blob([csvData], {type:"text/csv;charset=utf-8;"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "voter_list.csv";
    link.click();
});
</script>
</body>
</html>
