<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Clean Voter CSV</title>
</head>
<body>
<h2>Paste Voter Data</h2>
<textarea id="rawData" rows="15" cols="100" placeholder="Paste messy voter data here..."></textarea>
<br><br>
<button onclick="generateCSV()">Generate CSV</button>
<br><br>
<textarea id="csvOutput" rows="15" cols="100" placeholder="Clean CSV will appear here"></textarea>
<br>
<button onclick="copyCSV()">Copy CSV</button>

<script>
function generateCSV() {
    const rawText = document.getElementById('rawData').value;
    const lines = rawText.split(/\r?\n/);

    const csvRows = [];
    csvRows.push("SerialNo,EPIC_NO,PartNo,VoterName,RelationName,RelationType,HouseNo,Age,Gender");

    let serialNo = "", epicNo = "", partNo = "", voterName = "", relationName = "", relationType = "", houseNo = "", age = "", gender = "";

    lines.forEach(line => {
        line = line.trim();
        if (!line) return; // skip empty
        if (line.startsWith("<") || line.startsWith("} else") || line.startsWith("function") || line.startsWith("//")) return; // skip HTML/JS comments

        // Detect serialNo: number or NA at start
        const serialMatch = line.match(/^(\d+|NA)/);
        if (serialMatch) {
            if (voterName) { // push previous row
                csvRows.push([
                    serialNo, epicNo, partNo, `"${voterName}"`, relationName, relationType, `"${houseNo}"`, `"${age}"`, gender
                ].join(","));
            }

            // Reset for new row
            serialNo = serialMatch[1];
            epicNo = "";
            partNo = "";
            voterName = "";
            relationName = "";
            relationType = "";
            houseNo = "";
            age = "";
            gender = "";

            // Extract EPIC_NO / PartNo if present
            const parts = line.split(/[\s,]+/);
            if (parts[1] && parts[1].startsWith("RBG")) epicNo = parts[1];
            if (parts[2]) partNo = parts[2];
            voterName = parts.slice(3).join(" ").trim();
        } else {
            // Detect relationType
            if (line.match(/Husband|Father|Mother/i)) relationType = line;
            // Detect gender
            if (line.match(/Male|Female|स्त्री|पु/i)) gender = line;
            // Detect houseNo
            if (line.match(/घर क्रमांक/i)) houseNo = line;
            // Detect age (numbers)
            if (line.match(/^\d+$/)) age = line;
            // If still voterName empty
            if (!voterName) voterName = line;
        }
    });

    // Push last row
    if (voterName) {
        csvRows.push([
            serialNo, epicNo, partNo, `"${voterName}"`, relationName, relationType, `"${houseNo}"`, `"${age}"`, gender
        ].join(","));
    }

    document.getElementById('csvOutput').value = csvRows.join("\n");
}

function copyCSV() {
    const csvText = document.getElementById('csvOutput');
    csvText.select();
    document.execCommand("copy");
    alert("CSV copied!");
}
</script>
</body>
</html>
